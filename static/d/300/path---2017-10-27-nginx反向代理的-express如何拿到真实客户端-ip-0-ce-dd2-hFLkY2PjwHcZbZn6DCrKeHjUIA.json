{"data":{"site":{"siteMetadata":{"title":"进击的前端","author":"ricosmall"}},"markdownRemark":{"id":"f206a74a-8abe-5ddd-9bd3-c58675a13411","excerpt":"最近碰到一个苦恼的问题，Express 的后端打印客户端的真实 IP 地址，结果打印出来的全部是 。如果你也碰到了这个问题，那么恭喜你，我接下来就告诉你怎么解决。 正常来说，引起这个问题的原因就是服务器做了 nginx 反向代理。所有客户端的请求都先打到 nginx…","html":"<p>最近碰到一个苦恼的问题，Express 的后端打印客户端的真实 IP 地址，结果打印出来的全部是<code class=\"language-text\">127.0.0.1</code>。如果你也碰到了这个问题，那么恭喜你，我接下来就告诉你怎么解决。</p>\n<!-- more -->\n<p>正常来说，引起这个问题的原因就是服务器做了 nginx 反向代理。所有客户端的请求都先打到 nginx 服务器，然后 nginx 服务器再去请求 node 服务器，如果 nginx 和 node 服务器部署在同一台机上面，那么 node 能拿到的 IP 地址其实就是本机地址，也就是<code class=\"language-text\">127.0.0.1</code>。</p>\n<p>找到引起问题的根源，就可以对症下药了。</p>\n<h3>修改 nginx 配置</h3>\n<p>配置修改如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">server {\n    listen       80;\n    server_name  website.com;\n\n    location / {\n        proxy_set_header  Host $host;\n        proxy_set_header  X-Real-IP $remote_addr;\n        proxy_set_header  X-Forwarded-Proto https;\n        proxy_set_header  X-Forwarded-For $remote_addr;\n        proxy_set_header  X-Forwarded-Host $remote_addr;\n        proxy_pass    http://127.0.0.1:3000/;\n\n    }\n}</code></pre></div>\n<h3>修改 Express 配置</h3>\n<p>修改 <code class=\"language-text\">app.js</code> 文件，增加一行代码：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">app<span class=\"token punctuation\">.</span><span class=\"token keyword\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'trust proxy'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'loopback'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h3>获取客户端真实 IP 地址</h3>\n<p>在代码中使用<code class=\"language-text\">req.ip</code>就可以获取到用户的真实 IP 地址了。</p>","frontmatter":{"title":"nginx反向代理的Express如何拿到真实客户端IP","date":"October 27, 2017"}}},"pageContext":{"slug":"/2017-10-27-nginx反向代理的Express如何拿到真实客户端IP/","previous":{"fields":{"slug":"/2017-10-18-Linux下SVN账号密码保存方法/"},"frontmatter":{"title":"Linux下SVN账号密码保存方法"}},"next":{"fields":{"slug":"/2017-11-24-XSS防御/"},"frontmatter":{"title":"XSS防御"}}}}