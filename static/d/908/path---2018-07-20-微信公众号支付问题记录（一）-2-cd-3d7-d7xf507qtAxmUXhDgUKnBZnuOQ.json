{"data":{"site":{"siteMetadata":{"title":"进击的前端","author":"ricosmall"}},"markdownRemark":{"id":"d07df2ff-c5c6-5a67-b2c7-99e90d6b7577","excerpt":"问题描述 开发项目的过程中发现，微信支付分很多种，其中两种是本次会提到的： 和 。在微信外面打开的网页可以用 ，在微信里面打开该网页的时候只能使用 。 微信登陆失败 调用微信公众号支付需要拿到用户的 openid…","html":"<h2>问题描述</h2>\n<p>开发项目的过程中发现，微信支付分很多种，其中两种是本次会提到的：<code class=\"language-text\">H5 支付</code>和<code class=\"language-text\">公众号支付</code>。在微信外面打开的网页可以用<code class=\"language-text\">H5 支付</code>，在微信里面打开该网页的时候只能使用<code class=\"language-text\">公众号支付</code>。</p>\n<!-- more -->\n<h2>微信登陆失败</h2>\n<p>调用微信公众号支付需要拿到用户的 openid，这里涉及到微信网页授权。在授权的过程中可能会碰到以下问题：</p>\n<h3>redirect_uri 域名与后台配置不一致</h3>\n<p>错误信息：</p>\n<blockquote>\n<p>redirect_uri 域名与后台配置不一致，错误码：10003</p>\n</blockquote>\n<p>错误截图：</p>\n<p><img src=\"https://ricosmall.oss-cn-shenzhen.aliyuncs.com/18-7-20/27197160.jpg\" alt=\"redirect_uri 错误\"></p>\n<p>问题原因及解决办法：</p>\n<p>获取 openid 需要重定向到微信的链接地址，格式如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">https://open.weixin.qq.com/connect/oauth2/authorize?appid=APPID&amp;redirect_uri=REDIRECT_URI&amp;response_type=code&amp;scope=SCOPE&amp;state=STATE#wechat_redirect</code></pre></div>\n<p>其中有个参数 redirect_uri，意思是微信授权成功后的回调地址，这个回调地址必须是微信公众号设置里面「网页授权域名」下面的地址，否则会报以上错误。</p>\n<p>需要注意的是，此处的「网页授权域名」必须是精确的域名。如果 redirect<em>uri 为 xxx.com/xxx.html，那就要填写 xxx.com。如果 redirect</em>uri 为 xxx.xxx.com/xxx.html，那就要填写 xxx.xxx.com。</p>\n<p>还有一个隐藏的问题，如果有多个域名下的网页需要获取 openid，即微信网页授权，就会碰到「网页授权域名」只能填写一个而导致其他域名下的地址都无法作为 redirect_uri 的值。这里比较合适的做法就是通过已经填写的那个「网页授权域名」做一个中转，此处不详述中转做法。</p>\n<h3>不支持微信开放平台 Appid</h3>\n<p>错误信息：</p>\n<blockquote>\n<p>不支持开放平台 Appid，请使用公众号 Appid，错误代码：10016</p>\n</blockquote>\n<p>错误截图：</p>\n<p><img src=\"https://ricosmall.oss-cn-shenzhen.aliyuncs.com/18-7-20/667058.jpg\" alt=\"不支持开放平台 Appid\"></p>\n<p>问题原因及解决办法：</p>\n<p>上一个问题中，重定向到微信的地址时需要填写 appid 的参数，这个参数一定要用公众号的 appid。</p>\n<h2>调用公众号支付失败</h2>\n<h3>调用支付 JSAPI 缺少参数</h3>\n<p>错误信息：</p>\n<blockquote>\n<p>调用支付 JSAPI 缺少参数：total_fee</p>\n</blockquote>\n<p>错误截图：</p>\n<p><img src=\"https://ricosmall.oss-cn-shenzhen.aliyuncs.com/18-7-20/43053749.jpg\" alt=\"调用支付 JSAPI 缺少参数\"></p>\n<p>问题原因及解决办法：</p>\n<p>官方调用支付 JSAPI 示例如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">onBridgeReady</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    WeixinJSBridge<span class=\"token punctuation\">.</span><span class=\"token function\">invoke</span><span class=\"token punctuation\">(</span>\n        <span class=\"token string\">'getBrandWCPayRequest'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"appId\"</span><span class=\"token punctuation\">:</span><span class=\"token string\">\"wx2421b1c4370ec43b\"</span><span class=\"token punctuation\">,</span>                        <span class=\"token comment\">//公众号名称，由商户传入</span>\n            <span class=\"token string\">\"timeStamp\"</span><span class=\"token punctuation\">:</span><span class=\"token string\">\"1395712654\"</span><span class=\"token punctuation\">,</span>                            <span class=\"token comment\">//时间戳，自1970年以来的秒数</span>\n            <span class=\"token string\">\"nonceStr\"</span><span class=\"token punctuation\">:</span><span class=\"token string\">\"e61463f8efa94090b1f366cccfbbb444\"</span><span class=\"token punctuation\">,</span>       <span class=\"token comment\">//随机串</span>\n            <span class=\"token string\">\"package\"</span><span class=\"token punctuation\">:</span><span class=\"token string\">\"prepay_id=u802345jgfjsdfgsdg888\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"signType\"</span><span class=\"token punctuation\">:</span><span class=\"token string\">\"MD5\"</span><span class=\"token punctuation\">,</span>                                    <span class=\"token comment\">//微信签名方式：</span>\n            <span class=\"token string\">\"paySign\"</span><span class=\"token punctuation\">:</span><span class=\"token string\">\"70EA570631E4BB79628FBCA90534C63FF7FADD89\"</span> <span class=\"token comment\">//微信签名</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">.</span>err_msg <span class=\"token operator\">==</span> <span class=\"token string\">\"get_brand_wcpay_request:ok\"</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// 使用以上方式判断前端返回,微信团队郑重提示：</span>\n            <span class=\"token comment\">// res.err_msg将在用户支付成功后返回ok，但并不保证它绝对可靠。</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> WeixinJSBridge <span class=\"token operator\">==</span> <span class=\"token string\">\"undefined\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>document<span class=\"token punctuation\">.</span>addEventListener<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        document<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'WeixinJSBridgeReady'</span><span class=\"token punctuation\">,</span> onBridgeReady<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>document<span class=\"token punctuation\">.</span>attachEvent<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        document<span class=\"token punctuation\">.</span><span class=\"token function\">attachEvent</span><span class=\"token punctuation\">(</span><span class=\"token string\">'WeixinJSBridgeReady'</span><span class=\"token punctuation\">,</span> onBridgeReady<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        document<span class=\"token punctuation\">.</span><span class=\"token function\">attachEvent</span><span class=\"token punctuation\">(</span><span class=\"token string\">'onWeixinJSBridgeReady'</span><span class=\"token punctuation\">,</span> onBridgeReady<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">onBridgeReady</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>要特别注意 package 参数，必须是 <code class=\"language-text\">prepay_id=xxx</code> 这种形式。</p>\n<h3>商户传入的 appid 参数不正确</h3>\n<p>错误信息：</p>\n<blockquote>\n<p>商户传入的 appid 参数不正确，请联系商户处理。</p>\n</blockquote>\n<p>错误截图：</p>\n<p><img src=\"https://ricosmall.oss-cn-shenzhen.aliyuncs.com/18-7-20/19805189.jpg\" alt=\"商户传入的 appid 参数不正确\"></p>\n<p>错误原因及解决办法：</p>\n<p>这种情况一般是后端用错了 appid 导致，可能是后端错误地用成了开放平台的 appid 导致。此处采用的是公众号支付，因此一定要传公众号的 appid。</p>\n<h3>支付验证签名失败</h3>\n<p>错误信息：</p>\n<blockquote>\n<p>支付验证签名失败。</p>\n</blockquote>\n<p>错误截图：</p>\n<p><img src=\"https://ricosmall.oss-cn-shenzhen.aliyuncs.com/18-7-20/68276262.jpg\" alt=\"支付验证签名失败\"></p>\n<p>错误原因及解决办法：</p>\n<p>这种情况就是签名算法的问题。微信开放平台支付的签名算法和公众号支付的签名算法是不同的，表现在以下两个方面：公众号支付的签名算法要求注意大小写，开放平台支付的签名是全小写的；公众号支付的签名字段和开放平台支付的签名字段不一样。此处严格按照官方文档去写签名算法就好了。</p>","frontmatter":{"title":"微信公众号支付问题记录（一）","date":"July 20, 2018"}}},"pageContext":{"slug":"/2018-07-20-微信公众号支付问题记录（一）/","previous":{"fields":{"slug":"/2018-03-30-解决Vue项目中audio元素在移动端无法自动播放的问题/"},"frontmatter":{"title":"解决Vue项目中audio元素在移动端无法自动播放的问题"}},"next":null}}